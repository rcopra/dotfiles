#!/bin/bash
# vim: set ft=bash:
# chezmoi:template:hash:{{ include "run_onchange_install-packages.sh.tmpl" | sha256sum }}

set -euo pipefail

echo "==> Installing packages for {{ .chezmoi.os }} ({{ .chezmoi.arch }})"

{{ if eq .chezmoi.os "darwin" -}}
# ==============================================================================
# macOS Installation (Homebrew)
# ==============================================================================

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "==> Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

echo "==> Installing CLI tools..."
brew install \
    chezmoi \
    git \
    neovim \
    tmux \
    fzf \
    eza \
    zoxide \
    ripgrep \
    fd \
    bat \
    jq \
    oh-my-posh

echo "==> Installing version managers..."
brew install rbenv pyenv nvm

echo "==> Installing applications..."
brew install --cask wezterm

# Fonts
echo "==> Installing fonts..."
brew install --cask font-meslo-lg-nerd-font

{{ else if eq .chezmoi.os "linux" -}}
# ==============================================================================
# Linux Installation
# ==============================================================================

# Detect package manager
if command -v apt &> /dev/null; then
    # Debian/Ubuntu/Raspberry Pi OS
    echo "==> Detected apt (Debian-based)"

    sudo apt update
    sudo apt install -y \
        git \
        neovim \
        tmux \
        fzf \
        ripgrep \
        fd-find \
        bat \
        jq \
        zsh \
        curl \
        wget \
        build-essential \
        xclip

    # Install eza (not in default repos)
    if ! command -v eza &> /dev/null; then
        echo "==> Installing eza..."
        sudo mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
        echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
        sudo apt update
        sudo apt install -y eza
    fi

    # Install zoxide
    if ! command -v zoxide &> /dev/null; then
        echo "==> Installing zoxide..."
        curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
    fi

    # Install oh-my-posh
    if ! command -v oh-my-posh &> /dev/null; then
        echo "==> Installing oh-my-posh..."
        curl -s https://ohmyposh.dev/install.sh | bash -s
    fi

elif command -v pacman &> /dev/null; then
    # Arch Linux (Omarchy)
    echo "==> Detected pacman (Arch-based)"

    sudo pacman -Syu --noconfirm \
        git \
        neovim \
        tmux \
        fzf \
        eza \
        zoxide \
        ripgrep \
        fd \
        bat \
        jq \
        zsh \
        xclip \
        base-devel

    # Install oh-my-posh from AUR
    if ! command -v oh-my-posh &> /dev/null; then
        if command -v yay &> /dev/null; then
            yay -S --noconfirm oh-my-posh-bin
        elif command -v paru &> /dev/null; then
            paru -S --noconfirm oh-my-posh-bin
        else
            echo "==> WARNING: No AUR helper found. Install oh-my-posh manually."
        fi
    fi
fi

# ==============================================================================
# Universal Linux: Version Managers
# ==============================================================================

# rbenv
if [ ! -d "$HOME/.rbenv" ]; then
    echo "==> Installing rbenv..."
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
    git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
fi

# pyenv
if [ ! -d "$HOME/.pyenv" ]; then
    echo "==> Installing pyenv..."
    curl https://pyenv.run | bash
fi

# nvm
if [ ! -d "$HOME/.nvm" ]; then
    echo "==> Installing nvm..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash
fi

{{ end -}}

echo "==> Package installation complete!"
