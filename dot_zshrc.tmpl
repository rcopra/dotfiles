# ==============================================================================
# Environment Variables
# ==============================================================================
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export EDITOR={{ if lookPath "code" }}code{{ else }}nvim{{ end }}
export BUNDLER_EDITOR={{ if lookPath "code" }}code{{ else }}nvim{{ end }}
export HOMEBREW_NO_ANALYTICS=1

# Ruby
export DISABLE_SPRING=true
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
export RUBYOPT="-r$HOME/.rubyopenssl_default_store.rb $RUBYOPT"

# Python
export PYENV_VIRTUALENV_DISABLE_PROMPT=1
export PYTHONBREAKPOINT=ipdb.set_trace

# Node (fnm - Fast Node Manager)

# ==============================================================================
# PATH Configuration
# ==============================================================================
{{- if eq .chezmoi.os "darwin" }}
# Homebrew (Apple Silicon)
export PATH="/opt/homebrew/bin:${PATH}"
export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
{{- else if eq .chezmoi.os "linux" }}
# Linux Homebrew (if installed)
if [ -d "/home/linuxbrew/.linuxbrew" ]; then
    export PATH="/home/linuxbrew/.linuxbrew/bin:${PATH}"
fi
# Standard PostgreSQL paths for Linux
if [ -d "/usr/lib/postgresql/16/bin" ]; then
    export PATH="/usr/lib/postgresql/16/bin:$PATH"
fi
{{- end }}

# Local binaries
export PATH="$HOME/.local/bin:$PATH"
export PATH="${HOME}/.rbenv/bin:${PATH}"

# Project-local binaries (Rails binstubs, node_modules)
export PATH="./bin:./node_modules/.bin:${PATH}:/usr/local/sbin"

# ==============================================================================
# Zsh Options & Completions
# ==============================================================================
autoload -Uz compinit
# Only regenerate completion cache once per day
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
  compinit
else
  compinit -C
fi
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# ==============================================================================
# Version Managers (lazy-loaded for fast startup)
# ==============================================================================
# rbenv (Ruby) - lazy-load on first use
if type -a rbenv > /dev/null; then
  _init_rbenv() {
    unfunction _init_rbenv rbenv ruby gem bundle rake rails 2>/dev/null
    eval "$(command rbenv init -)"
  }
  rbenv() { _init_rbenv; rbenv "$@" }
  ruby() { _init_rbenv; ruby "$@" }
  gem() { _init_rbenv; gem "$@" }
  bundle() { _init_rbenv; bundle "$@" }
  rake() { _init_rbenv; rake "$@" }
  rails() { _init_rbenv; rails "$@" }
fi

# pyenv (Python) - lazy-load on first use
if type -a pyenv > /dev/null; then
  _init_pyenv() {
    unfunction _init_pyenv pyenv python python3 pip pip3 2>/dev/null
    eval "$(command pyenv init -)"
  }
  pyenv() { _init_pyenv; pyenv "$@" }
  python() { _init_pyenv; python "$@" }
  python3() { _init_pyenv; python3 "$@" }
  pip() { _init_pyenv; pip "$@" }
  pip3() { _init_pyenv; pip3 "$@" }
fi

# fnm (Fast Node Manager) - auto-switches on .nvmrc/.node-version
command -v fnm > /dev/null && eval "$(fnm env --use-on-cd)"

# ==============================================================================
# History (configured by OMZ lib/history.zsh)
# ==============================================================================
# OMZ handles this, but we override a few settings
HISTFILE=$HOME/.zhistory
HISTSIZE=10000
SAVEHIST=10000

# ==============================================================================
# Zinit Plugin Manager
# ==============================================================================
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"

# Install zinit if not present
if [[ ! -d "$ZINIT_HOME" ]]; then
  mkdir -p "$(dirname $ZINIT_HOME)"
  git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi

source "${ZINIT_HOME}/zinit.zsh"

# Load OMZ library components (provides key bindings, completions, etc.)
zinit snippet OMZL::key-bindings.zsh
zinit snippet OMZL::completion.zsh
zinit snippet OMZL::history.zsh
zinit snippet OMZL::directories.zsh

# OMZ plugins
zinit snippet OMZP::git

# Zsh plugins (turbo mode - load after prompt renders)
zinit wait lucid for \
  zsh-users/zsh-autosuggestions \
  zsh-users/zsh-history-substring-search \
  zsh-users/zsh-syntax-highlighting

# ==============================================================================
# Key Bindings (OMZ lib/key-bindings.zsh handles basics)
# ==============================================================================
# History substring search (up/down arrows) - bind after plugin loads
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down

# ==============================================================================
# Modern CLI Tools
# ==============================================================================
# eza (modern ls)
command -v eza > /dev/null && alias ls="eza --icons=always"

# zoxide (smarter cd)
command -v zoxide > /dev/null && eval "$(zoxide init zsh)" && alias cd="z"

# ==============================================================================
# Prompt (Oh My Posh)
# ==============================================================================
{{- if eq .chezmoi.os "darwin" }}
if [ "$TERM_PROGRAM" != "Apple_Terminal" ]; then
  command -v oh-my-posh > /dev/null && eval "$(oh-my-posh init zsh --config ~/.config/ohmyposh/config.toml)"
fi
{{- else }}
# Linux - always use Oh My Posh if available
command -v oh-my-posh > /dev/null && eval "$(oh-my-posh init zsh --config ~/.config/ohmyposh/config.toml)"
{{- end }}

# ==============================================================================
# Aliases & Local Config
# ==============================================================================
# Custom aliases
[[ -f "$HOME/.aliases" ]] && source "$HOME/.aliases"

# Local environment variables (secrets, tokens, etc.) - not tracked in git
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"
